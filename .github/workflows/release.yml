name: FileCraft Auto Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    # 1. Checkout the repository
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: 'main'

    # 2. Setup .NET 9 SDK
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    # 3. Extract Version from .csproj
    - name: Get Version from Project
      id: get_version
      run: |
        $ver = dotnet msbuild FileCraft.csproj -getProperty:Version
        echo "Detected version from csproj: $ver"
        echo "APP_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

    # 4. Restore NuGet packages
    - name: Restore dependencies
      run: dotnet restore

    # 5. Build and Publish the application
    # Creates the single-file executable.
    - name: Build and publish
      run: dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true --output ./publish

    # 6. Rename the executable to include version number (e.g., FileCraft_v6.4.2.exe)
    - name: Rename Executable
      run: |
        cd publish
        Rename-Item -Path "FileCraft.exe" -NewName "FileCraft_v${{ env.APP_VERSION }}.exe"
        cd ..

    # 7. Create a ZIP archive with the versioned name
    - name: Zip the artifacts
      run: |
        $zipName = "FileCraft_v${{ env.APP_VERSION }}.zip"
        Compress-Archive -Path ./publish/* -DestinationPath $zipName
        echo "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

    # 8. Create GitHub Release
    # Uploads the versioned zip file as a release asset.
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ZIP_NAME }}
        name: "FileCraft Release v${{ env.APP_VERSION }}"
        tag_name: "v${{ env.APP_VERSION }}"
        token: ${{ secrets.GITHUB_TOKEN }}
        make_latest: true